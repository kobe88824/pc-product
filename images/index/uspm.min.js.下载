!function(a){if(a&&window.JEND){var b={data:["","","","","",""],attr:{base:"data-uspm",form:"data-uspm-form",type:"data-uspm-type",page:"data-uspm-id",list:"data-uspm-id",item:"data-uspm-id",count:"data-uspm-count"},tmpl:{page:"{0}.{1}.{2}.0.0.{5}",list:"{0}.{1}.{2}.{3}.0.{5}",item:"{0}.{1}.{2}.{3}.{4}.{5}"},selector:{con:"[data-uspm]",list:"[data-uspm]:not(a,area,span,input,button)",link:"a,area",button:"img[data-uspm],span[data-uspm],label[data-uspm],input[data-uspm],button[data-uspm]"},selector2:{list:"[data-uspm-count]",link:"a[data-uspm-id],area[data-uspm-id]",button:"img[data-uspm-id],span[data-uspm-id],label[data-uspm-id],input[data-uspm-id],button[data-uspm-id]"},status:0,debug:function(a,b,c){this.debugMode&&(c||(c=b,b=0),b>0?this.console[a](b,c):this.console[a](c))},initDebug:function(){this.console=window.console||{},this.console.log||(this.console.log=function(){}),this.console.info||(this.console.info=function(){}),this.console.warn||(this.console.warn=function(){}),this.console.group||(this.console.group=function(){}),this.console.groupEnd||(this.console.groupEnd=function(){}),this.console.time||(this.console.time=function(){}),this.console.timeEnd||(this.console.timeEnd=function(){})},getPVID:function(){if(window.g_uspm_pvid)return g_uspm_pvid;for(var a="0123456789",b=a.length,c="";c.length<6;)c+=a.substr(Math.floor(Math.random()*b),1);return c},init:function(){this.initDebug(),this.initPage(),1==this.status&&(this.initSearch(),this.bindEvent())},initPage:function(){var b=a("meta[name="+this.attr.base+"]").attr("content")||"",c=a("body").attr(this.attr.base)||"",d=b?b.split("."):[],e=c?c.split("."):[];if(d.length>0&&(this.data[0]=d.shift()),d.length>0&&(this.data[1]=d.shift()),e.length>0&&(this.data[2]=e.pop()),e.length>0&&(this.data[1]=e.pop()),e.length>0&&(this.data[0]=e.pop()),""==this.data[0])this.debug("warn",401,"页面uspm初始化失败： 请在页面<meta>中定义站点ID和站点类型");else if(""==this.data[2])this.debug("warn",401,"页面uspm初始化失败： 请在页面<body>中定义页面ID");else if(""==this.data[1])this.debug("warn",401,"页面uspm初始化失败： 请在页面<meta>或<body>中定义站点ID");else{this.status=1,this.data[5]=1;var f=this.tmpl.page.format(this.data);a("body").attr(this.attr.page,f).removeAttr(this.attr.base),this.postPageTrack(f),this.debug("info",201,"页面初始化， uspm = "+f)}this.pageurl=document.location.href,this.pageurl.indexOf("#")>=0&&(this.pageurl=this.pageurl.sliceBefore("#"))},initSearch:function(){a("form["+b.attr.form+"]").each(function(){var a=b.data.slice(0),c=this.getAttribute(b.attr.form)||"",d=c?c.split("."):[];if(0!=d.length){d.length>0&&(a[3]=d.pop()),d.length>0&&(a[2]=d.pop()),d.length>0&&(a[1]=d.pop()),d.length>0&&(a[0]=d.pop());var e=b.tmpl.list.format(a);this.setAttribute(b.attr.form,e);var f=this.action;f&&(f+=(f.indexOf("?")>0?"&":"?")+"uspm="+e,this.setAttribute("action",f)),b.debug("info",205,"搜索初始化，uspm = "+e)}}),a("form input[name=uspm]").each(function(){var a=b.data.slice(0),c=this.getAttribute(b.attr.base)||"",d=c?c.split("."):[];if(a[4]="{0}",0!=d.length){d.length>0&&(a[3]=d.pop()),d.length>0&&(a[2]=d.pop()),d.length>0&&(a[1]=d.pop()),d.length>0&&(a[0]=d.pop());var e=b.tmpl.item.format(a);this.setAttribute(b.attr.list,e),this.removeAttribute(b.attr.base),b.debug("info",205,"搜索初始化，uspm = "+e)}})},bindEvent:function(){a(document).bind("mousedown",function(a){b.execute(a)}),a(document).bind("keydown",function(a){b.execute(a)})},execute:function(b){for(var c,d=b.target,e="";d&&(e=d.tagName.toLowerCase());){if("a"==e||"area"==e){c=a(d).parents(this.selector.con),c.size()>0&&!d.getAttribute(this.attr.item)&&this.updateModContent(c.eq(0)),d.getAttribute(this.attr.item)&&this.addClickStat(d);break}if("img"==e||"label"==e||"span"==e||"input"==e||"button"==e){if(c=a(d).parents(this.selector.con),c.size()>0&&d.getAttribute(this.attr.base)&&this.updateModContent(c),d.getAttribute(this.attr.item)){this.addClickStat(d);break}}else if("div"==e||"ul"==e||"ol"==e||"ul"==e||"p"==e||"form"==e||"body"==e||"html"==e)break;d=d.parentNode}},addClickStat:function(a){var b=a.getAttribute(this.attr.item)||"no",c=a.getAttribute("data-uspm-action")||"click",d=a.getAttribute("data-uspm-extend")||"",e=a.lastClickTime||0,f=(new Date).getTime();"no"!=b&&f-e>5e3&&(this.postClickTrack(b,c,d),a.lastClickTime=f)},postPageTrack:function(a){var c=0,d=function(){try{window._hmt?(setTimeout(function(){_hmt.push(["_trackPageview","/virtual/page/uspm/"+a])},100),b.debug("info",208,"添加访问统计成功，uspm = "+a)):10>c&&(c++,setTimeout(function(){d()},500))}catch(e){b.debug("warn",408,"添加访问统计失败，uspm = "+a)}};d()},postClickTrack:function(a,b,c){try{setTimeout(function(){window._utrack&&_utrack.push(["_trackEvent","uspm",b||"click",a,c||""]),window._hmt&&_hmt.push(["_trackPageview","/virtual/click/uspm/"+a])},100)}catch(d){}},updateModContent:function(a){var b=this.data.slice(0),c=a.attr(this.attr.base)||"",d=c?c.split("."):[];d.length>0&&(b[3]=d.pop()),d.length>0&&(b[2]=d.pop()),d.length>0&&(b[1]=d.pop()),d.length>0&&(b[0]=d.pop());var e=this.tmpl.list.format(b);a.attr(this.attr.list,e).removeAttr(this.attr.base),this.debug("group","模块初始化， uspm = "+e),this.debug("time","初始化耗时"),this.updateModLinks(a,b),this.updateModButtons(a,b),this.debug("timeEnd","初始化耗时"),this.debug("groupEnd","模块初始化， uspm = "+e)},updateModLinks:function(c,d){var e=0,f=c.attr(this.attr.type)||"child";c.removeAttr(this.attr.type),"all"==f?c.find(this.selector.link).each(function(a){b.updateLink(this,d,a+1),e++}):c.children().each(function(c){var f=this.tagName.toLowerCase();"a"==f||"area"==f?b.updateLink(this,d,c+1):a(this).find(b.selector.link).each(function(){b.updateLink(this,d,c+1)}),e++}),c.attr(this.attr.count,e),this.debug("info",203,"共处理 "+e+" 个链接内容")},updateModButtons:function(a,c){var d=0;a.find(this.selector.button).each(function(){if(this.getAttribute(b.attr.item))return!1;c[4]=this.getAttribute("data-uspm");var a=b.tmpl.item.format(c);this.setAttribute(b.attr.item,a),this.removeAttribute(b.attr.base),d++}),a.attr(this.attr.count,a.attr(this.attr.count)+"|"+d),this.debug("info",204,"共处理 "+d+" 个按钮内容")},updateLink:function(a,c,d){if(a.getAttribute(b.attr.item))return!1;var e,d=a.getAttribute(this.attr.base)||d,f=(a.getAttribute("href")||"").trim(),g="";if("no"!=d){if(c[4]=d,e=this.tmpl.item.format(c),a.setAttribute(this.attr.item,e),a.removeAttribute(this.attr.base),""!=f&&!f.startWith("#")&&!f.toLowerCase().startWith("javascript")){if(f.indexOf("#")>0&&(g="#"+f.sliceAfter("#"),f=f.sliceBefore("#"),f==this.pageurl))return!1;f.indexOf("?")>=0&&f.indexOf("uspm=")>0?f=f.replace(f.getQueryValue("uspm"),e):f+=(f.indexOf("?")>0?"&":"?")+"uspm="+e,a.setAttribute("href",f+g)}}else a.setAttribute(this.attr.item,"no"),a.removeAttribute(this.attr.base),this.debug("warn",403,"链接"+f+"已设置为不需要uspm")}};JEND.define("JEND.page.uspm",{setDebugOn:function(){b.debugMode=!0},loadPlugin:function(a){a.init&&a.init(b)},postTrack:function(a,c,d){b.postClickTrack(a,c,d)}},function(){JEND.page.refresh=function(c){c||(c=document.location.href,c.indexOf("#")>0&&(c=c.sliceBefore("#")));var d=a("body").attr(b.attr.page)||"";d&&c.indexOf("uspm=")<0&&(c+=(c.indexOf("?")>0?"&":"?")+"uspm="+d),document.location.href=c},b.init()})}}(jQuery);